----------------------------------------------------------------------------------------------------
----- SoldTo
----------------------------------------------------------------------------------------------------
3574184-QUBICAAMFB.V.-NCP/MOD
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- ShipTo
----------------------------------------------------------------------------------------------------
3574184-QUBICAAMFB.V.-NCP/MOD
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- MakeFor
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- ProjectType
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- CustomerType
----------------------------------------------------------------------------------------------------
AFF-Affiliate
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- SalesArea
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- SalesRegion
----------------------------------------------------------------------------------------------------
EME-Europe
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- SalesGrouping
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- BowlingCenterChain
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- Country
----------------------------------------------------------------------------------------------------
NL-Netherlands
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- State
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- SalesRep
----------------------------------------------------------------------------------------------------
284476-Salesperson-Unspecified
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- BranchPlant
----------------------------------------------------------------------------------------------------
7110
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- OrderType
----------------------------------------------------------------------------------------------------
S3
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- OrderNumber
----------------------------------------------------------------------------------------------------
663976
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- LineNumber
----------------------------------------------------------------------------------------------------
1.014
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- OrderDate
----------------------------------------------------------------------------------------------------
40423
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- RequestedDate
----------------------------------------------------------------------------------------------------
40449
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- ItemNumber
----------------------------------------------------------------------------------------------------
Q941760BL
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- LineType
----------------------------------------------------------------------------------------------------
ZS
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- Description
----------------------------------------------------------------------------------------------------
HWY66BlackLanePackage
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- DocumentNumber
----------------------------------------------------------------------------------------------------
1691839
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- InvoiceDate
----------------------------------------------------------------------------------------------------
40492
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- ItemPriceGroups
----------------------------------------------------------------------------------------------------
PEDTHUND
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- ProductLine
----------------------------------------------------------------------------------------------------
700
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- Product
----------------------------------------------------------------------------------------------------
199
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- Sub-Product
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- ListPrice
----------------------------------------------------------------------------------------------------
0
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- PricePerUnit
----------------------------------------------------------------------------------------------------
0
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- Currency
----------------------------------------------------------------------------------------------------
USD
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- ActualShipDate
----------------------------------------------------------------------------------------------------
40492
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- QtyOrderTransact
----------------------------------------------------------------------------------------------------
1
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- ExtendedAmount
----------------------------------------------------------------------------------------------------
0
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- PartNumOK
----------------------------------------------------------------------------------------------------
IF(
	IFERROR(
		VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[Part '#]],1,FALSE)
		,IFERROR(
			VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[Description]],1,FALSE)
			,"N/A"
		)
	)="N/A"
	,"N/A"
	,"OK"
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- MainOrder
----------------------------------------------------------------------------------------------------
IF(
	OR(
		[@OrderNumber]="15730391"
		,AND(
			LEFT([@CustomerType],10)="DIV - QAMF"
			,NOT(
				OR(
					LEFT([@SoldTo],6)="219246"
					,LEFT([@SoldTo],6)="249946"
					,LEFT([@SoldTo],6)="316977"
					,LEFT([@SoldTo],7)="3925218"
					,LEFT([@SoldTo],7)="4264819"
					,LEFT([@SoldTo],5)="8400 "
				)
			)
		)
	)
	,"Exclude"
	,IF(
		OR(
			[@OrderNumber]="16204094"
			,[@OrderNumber]="16204138"
		)
		,"P16204094-16204138 - SUITE SPOT"
		,IF(
			OR(
				[@MakeFor]=""
				,[@MakeFor]="0"
				,[@MakeFor]="0"
			)
			,"O"&[@OrderNumber]
			,"P"&[@MakeFor]
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsScoring
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,IFERROR(
		VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[Sc. Upg Lane]],3,FALSE)
		,IFERROR(
			VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[Sc. Upg Lane]],2,FALSE)
			,0
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsHW66
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,IF(
		IFERROR(
			AND(
				NUMBERVALUE([@OrderNumber])=16204094
				,NUMBERVALUE([@ItemNumber])=612060028
			)
			,0
		)
		,2
		,IFERROR(
			VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[IsAMU]],100,FALSE)
			,IFERROR(
				VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[IsAMU]],99,FALSE)
				,0
			)
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsUPG
----------------------------------------------------------------------------------------------------
IF(
	OR(
		[@MainOrder]="Exclude"
		,0
		,[@PartNumOK]="N/A"
	)
	,"_"
	,IFERROR(
		VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[Sc. Upg Lane]],4,FALSE)
		,VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[Sc. Upg Lane]],3,FALSE)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsOrdWUpg
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,SUMIFS([IsUPG],[MainOrder],[@MainOrder])
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsAMFScTrdIn
----------------------------------------------------------------------------------------------------
IF(
	OR(
		[@MainOrder]="Exclude"
		,0
		,[@PartNumOK]="N/A"
	)
	,"_"
	,IFERROR(
		VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[Is trade-in]],93,FALSE)
		,VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[Is trade-in]],92,FALSE)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsOrdWAMFScTrdIn
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,SUMIFS([IsAMFScTrdIn],[MainOrder],[@MainOrder])
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsAMFConv
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,"_"
	,IF(
		[@ItemNumber]="288601164-AMF"
		,1
		,0
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsOrdWAMFConv
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,SUMIFS([IsAMFConv],[MainOrder],[@MainOrder])
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsBrunConv
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,"_"
	,IF(
		[@ItemNumber]="288601164-BRUN"
		,1
		,0
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsOrdWBrunConv
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,SUMIFS([IsBrunConv],[MainOrder],[@MainOrder])
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsCProUPG
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,IFERROR(
		VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[Is UPG lic.]],51,FALSE)
		,IFERROR(
			VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[Is UPG lic.]],50,FALSE)
			,0
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsSuiteSpot
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,IF(
		IFERROR(
			AND(
				NUMBERVALUE([@OrderNumber])=16204094
				,NUMBERVALUE([@ItemNumber])=612060028
			)
			,0
		)
		,2
		,IFERROR(
			VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[BESXDMUPG]],95,FALSE)
			,IFERROR(
				VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[BESXDMUPG]],94,FALSE)
				,0
			)
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsTenpinTour
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,IFERROR(
		VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[BESXDMUPG]],96,FALSE)
		,IFERROR(
			VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[BESXDMUPG]],95,FALSE)
			,0
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsBESXDualMode
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,IFERROR(
		VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[BESXDMUPG]],97,FALSE)
		,IFERROR(
			VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[BESXDMUPG]],96,FALSE)
			,0
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsTenpinTourUPG
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,IFERROR(
		VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[BESXDMUPG]],98,FALSE)
		,IFERROR(
			VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[BESXDMUPG]],97,FALSE)
			,0
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsBESXDualModeUPG
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,IFERROR(
		VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[BESXDMUPG]],99,FALSE)
		,IFERROR(
			VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[BESXDMUPG]],98,FALSE)
			,0
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- MainPrLine
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,"_"
	,IF(
		NUMBERVALUE([@ProductLine])=700
		,"AMU"
		,"STS"
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- MainProductFamily
----------------------------------------------------------------------------------------------------
IF(
	OR(
		[@MainOrder]="Exclude"
		,[@PartNumOK]="N/A"
	)
	,"_"
	,IF(
		[@IsSuiteSpot]>0
		,"Suite Spot"
		,IF(
			[@IsHW66]>0
			,"Highway 66"
			,IFERROR(
				VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[Score family 2]],45,FALSE)
				,VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[Score family 2]],44,FALSE)
			)
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- ProductFamily
----------------------------------------------------------------------------------------------------
IF(
	OR(
		[@MainOrder]="Exclude"
		,[@PartNumOK]="N/A"
	)
	,"_"
	,IF(
		[@IsSuiteSpot]>0
		,"Suite Spot"
		,IF(
			[@IsHW66]>0
			,"Highway 66"
			,IFERROR(
				VLOOKUP([@ItemNumber],'part_filters'!PartNumFiltersTable[[Part '#]:[Score family 2]],44,FALSE)
				,VLOOKUP([@Description],'part_filters'!PartNumFiltersTable[[Description]:[Score family 2]],43,FALSE)
			)
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- UniqueOrder
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,IF(
		MATCH([@MainOrder],[[MainOrder]:[MainOrder]],0)<ROW([@MainOrder])-2
		,0
		,1
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- OrderY
----------------------------------------------------------------------------------------------------
YEAR([@OrderDate])
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- OrderM
----------------------------------------------------------------------------------------------------
MONTH([@OrderDate])
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- InvoicedY
----------------------------------------------------------------------------------------------------
IF(
	[@InvoiceDate]=""
	,""
	,YEAR([@InvoiceDate])
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- InvoicedM
----------------------------------------------------------------------------------------------------
IF(
	[@InvoiceDate]=""
	,""
	,MONTH([@InvoiceDate])
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- YearOfRef
----------------------------------------------------------------------------------------------------
IF(
	[@InvoicedY]=""
	,IF(
		OR(
			[@OrderM]<=$CQ$1
			,[@OrderY]=CurY
		)
		,[@OrderY]
		,[@OrderY]+1
	)
	,[@InvoicedY]
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- Test
----------------------------------------------------------------------------------------------------
IF(
	[@InvoicedY]=""
	,""
	,[@InvoicedY]-[@OrderY]
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- PrjType
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,"_"
	,IF(
		IFERROR(
			OR(
				[@OrderType]="S0"
				,NUMBERVALUE([@OrderNumber])=15811206
				,NUMBERVALUE([@OrderNumber])=15810892
				,NUMBERVALUE([@OrderNumber])=15811372
			)
			,FALSE
		)
		,"RENT"
		,IF(
			SUMIF([[MainOrder]:[MainOrder]],[@MainOrder],[[IsHW66]:[IsHW66]])>0
			,IF(
				SUMIF([[MainOrder]:[MainOrder]],[@MainOrder],[[IsScoring]:[IsScoring]])>0
				,"HW66-BES X"
				,"AMU"
			)
			,IF(
				[@IsOrdWUpg]>0
				,IF(
					OR(
						[@IsOrdWAMFScTrdIn]>0
						,[@IsOrdWAMFConv]>0
					)
					,"AMF UPG"
					,"UPG"
				)
				,IF(
					[@IsOrdWBrunConv]>0
					,"MOD BRW"
					,IF(
						SUMIF([[MainOrder]:[MainOrder]],[@MainOrder],[[IsScoring]:[IsScoring]])>0
						,IF(
							[@MainPrLine]="STS"
							,IF(
								MID([@OrderType],2,1)="3"
								,"MOD"
								,"NCP"
							)
							,"HW66-BES X"
						)
						,IF(
							SUMIF([[MainOrder]:[MainOrder]],[@MainOrder],[[IsCProUPG]:[IsCProUPG]])>0
							,"CProUPG"
							,IF(
								[@MainPrLine]="STS"
								,"MOD"
								,"AMU"
							)
						)
					)
				)
			)
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- Reg2
----------------------------------------------------------------------------------------------------
IF(
	LEFT([@SalesRegion],4)="BCO "
	,"Bowlmor AMF"
	,IF(
		OR(
			[@Country]=""
			,[@Country]="US - United States"
			,LEFT([@SalesRegion],1)="0"
		)
		,"US"
		,IF(
			OR(
				LEFT([@Country],2)="FR"
				,TRIM([@SalesRegion])=""
				,LEFT([@SalesRegion],3)="EME"
				,LEFT([@SalesRegion],3)="AFR"
			)
			,"EMEA"
			,IF(
				LEFT([@Country],2)="AU"
				,"AUS - Australia"
				,[@SalesRegion]
			)
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- MacroReg
----------------------------------------------------------------------------------------------------
IF(
	[@Country]=""
	,"AMER"
	,VLOOKUP(LEFT([@Country],2),'geo_filters'!Countries[[ISOCode2]:[Distr. Partner]],10,FALSE)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- SubReg
----------------------------------------------------------------------------------------------------
IF(
	[@Country]=""
	,"US"
	,IF(
		LEFT([@SoldTo],10)="6002509 - "
		,VLOOKUP("RO",'geo_filters'!Countries[[ISOCode2]:[Distr. Partner]],11,FALSE)
		,VLOOKUP(LEFT([@Country],2),'geo_filters'!Countries[[ISOCode2]:[Distr. Partner]],11,FALSE)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- USSubRegNoMIL
----------------------------------------------------------------------------------------------------
IFERROR(
	IF(
		LEFT([@CustomerType],3)="BCA"
		,"BAMF"
		,IF(
			OR(
				LEFT([@CustomerType],3)="MFO"
				,LEFT([@CustomerType],3)="MUS"
			)
			,IF(
				LEFT([@State],2)="AE"
				,"MIL-EU"
				,IF(
					LEFT([@State],2)="AP"
					,"MIL-PAC"
					,VLOOKUP(LEFT([@State],2),'geo_filters'!USRegionsTb[[ST1]:[DSM 3]],2,FALSE)
				)
			)
			,IF(
				IFERROR(
					SEARCH("MAIN EVENT",[@ShipTo])
					,0
				)>0
				,"ME"
				,IF(
					IFERROR(
						SEARCH("BOWL NEW ENGLAND",[@SoldTo])
						,0
					)>0
					,"BNE"
					,VLOOKUP(LEFT([@State],2),'geo_filters'!USRegionsTb[[ST1]:[DSM 3]],2,FALSE)
				)
			)
		)
	)
	,""
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- USSubReg
----------------------------------------------------------------------------------------------------
IFERROR(
	IF(
		LEFT([@CustomerType],3)="BCA"
		,"BAMF"
		,IF(
			OR(
				LEFT([@CustomerType],3)="MFO"
				,LEFT([@CustomerType],3)="MUS"
			)
			,IF(
				LEFT([@State],2)="AE"
				,"MIL-EU"
				,IF(
					LEFT([@State],2)="AP"
					,"MIL-PAC"
					,"MIL"
				)
			)
			,IF(
				IFERROR(
					SEARCH("MAIN EVENT",[@ShipTo])
					,0
				)>0
				,"ME"
				,IF(
					IFERROR(
						SEARCH("BOWL NEW ENGLAND",[@SoldTo])
						,0
					)>0
					,"BNE"
					,VLOOKUP(LEFT([@State],2),'geo_filters'!USRegionsTb[[ST1]:[DSM 3]],2,FALSE)
				)
			)
		)
	)
	,""
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- SubReg1
----------------------------------------------------------------------------------------------------
IF(
	OR(
		[@USSubReg]=""
		,LEFT([@USSubReg],2)="NA"
	)
	,[@SubReg]
	,"US-"&[@USSubReg]
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- DistrPartner
----------------------------------------------------------------------------------------------------
IF(
	[@PrjType]="RENT"
	,"Direct"
	,IF(
		LEFT([@SubReg1],2)="US"
		,[@SubReg1]
		,IF(
			LEFT(VLOOKUP(LEFT([@Country],2),'geo_filters'!Countries[[ISOCode2]:[Distr. Partner]],14,FALSE),5)="QAMF "
			,IF(
				OR(
					LEFT([@CustomerType],6)="D10 - "
					,LEFT([@CustomerType],6)="DIS - "
					,LEFT([@CustomerType],6)="DSR - "
				)
				,"Other distr."
				,IF(
					OR(
						LEFT([@MainOrder],11)="P6021914 - "
						,NUMBERVALUE([@OrderNumber])=16708128
						,AND(
							NOT(
								OR(
									LEFT(VLOOKUP(LEFT([@Country],2),'geo_filters'!Countries[[ISOCode2]:[Distr. Partner]],14,FALSE),7)="QAMF Fr"
									,LEFT(VLOOKUP(LEFT([@Country],2),'geo_filters'!Countries[[ISOCode2]:[Distr. Partner]],14,FALSE),7)="QAMF UK"
									,LEFT(VLOOKUP(LEFT([@Country],2),'geo_filters'!Countries[[ISOCode2]:[Distr. Partner]],14,FALSE),7)="QAMF AU"
								)
							)
							,NOT(
								LEFT([@CustomerType],6)="AFF - "
							)
						)
					)
					,"Direct"
					,IF(
						LEFT([@SoldTo],10)="6002509 - "
						,VLOOKUP("RO",'geo_filters'!Countries[[ISOCode2]:[Distr. Partner-Budget]],14,FALSE)
						,VLOOKUP(LEFT([@Country],2),'geo_filters'!Countries[[ISOCode2]:[Distr. Partner-Budget]],14,FALSE)
					)
				)
			)
			,IF(
				OR(
					[@CustomerType]=""
					,LEFT([@CustomerType],6)="BCI - "
					,LEFT([@CustomerType],6)="TRD - "
					,LEFT([@CustomerType],6)="BOW - "
					,NUMBERVALUE([@OrderNumber])=16708128
					,LEFT([@MainOrder],11)="P6021914 - "
				)
				,"Direct"
				,IF(
					LEFT([@SoldTo],10)="6002509 - "
					,VLOOKUP("RO",'geo_filters'!Countries[[ISOCode2]:[Distr. Partner-Budget]],14,FALSE)
					,VLOOKUP(LEFT([@Country],2),'geo_filters'!Countries[[ISOCode2]:[Distr. Partner-Budget]],14,FALSE)
				)
			)
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- MajorDistPartner
----------------------------------------------------------------------------------------------------
IF(
	[@PrjType]="RENT"
	,"Direct"
	,IF(
		LEFT([@SubReg1],2)="US"
		,[@SubReg1]
		,IF(
			LEFT([@DistrPartner],5)="QAMF "
			,IF(
				OR(
					LEFT([@CustomerType],6)="D10 - "
					,LEFT([@CustomerType],6)="DIS - "
					,LEFT([@CustomerType],6)="DSR - "
				)
				,"Other distr."
				,IF(
					OR(
						LEFT([@MainOrder],11)="P6021914 - "
						,NUMBERVALUE([@OrderNumber])=16708128
						,AND(
							NOT(
								OR(
									LEFT([@DistrPartner],7)="QAMF Fr"
									,LEFT([@DistrPartner],7)="QAMF UK"
									,LEFT([@DistrPartner],7)="QAMF AU"
								)
							)
							,NOT(
								LEFT([@CustomerType],6)="AFF - "
							)
						)
					)
					,"Direct"
					,IF(
						LEFT([@SoldTo],10)="6002509 - "
						,VLOOKUP("RO",'geo_filters'!Countries[[ISOCode2]:[Distr. Partner-Budget]],15,FALSE)
						,VLOOKUP(LEFT([@Country],2),'geo_filters'!Countries[[ISOCode2]:[Distr. Partner-Budget]],15,FALSE)
					)
				)
			)
			,IF(
				OR(
					[@CustomerType]=""
					,LEFT([@CustomerType],6)="BCI - "
					,LEFT([@CustomerType],6)="TRD - "
					,LEFT([@CustomerType],6)="BOW - "
					,NUMBERVALUE([@OrderNumber])=16708128
					,LEFT([@MainOrder],11)="P6021914 - "
				)
				,"Direct"
				,IF(
					LEFT([@SoldTo],10)="6002509 - "
					,VLOOKUP("RO",'geo_filters'!Countries[[ISOCode2]:[Distr. Partner-Budget]],15,FALSE)
					,VLOOKUP(LEFT([@Country],2),'geo_filters'!Countries[[ISOCode2]:[Distr. Partner-Budget]],15,FALSE)
				)
			)
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- SubReg2
----------------------------------------------------------------------------------------------------
IF(
	[@MajorDistPartner]="Direct"
	,"Direct"
	,[@SubReg1]
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsScPlusIsHW
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,[@IsScoring]+[@IsHW66]+SUM([@[IsTenpinTour]:[IsBESXDualModeUPG]])
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- YSH
----------------------------------------------------------------------------------------------------
IF(
	OR(
		AND(
			[@PrjType]="CProUPG"
			,[@UniqueOrder]=0
		)
		,AND(
			NOT(
				[@PrjType]="CProUPG"
			)
			,[@IsScPlusIsHW]+SUM([@[IsSuiteSpot]:[IsBESXDualModeUPG]])=0
		)
		,[@InvoicedM]>CurM
		,[@InvoicedY]=""
	)
	,""
	,[@InvoicedY]
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- YBL
----------------------------------------------------------------------------------------------------
IF(
	[@IsScPlusIsHW]+[@IsCProUPG]+SUM([@[IsSuiteSpot]:[IsBESXDualModeUPG]])=0
	,""
	,IF(
		[@InvoicedY]=""
		,IF(
			OR(
				CurM>=[@OrderM]
				,CurY>[@OrderY]
			)
			,CurY
			,""
		)
		,IF(
			CurM>=[@OrderM]
			,IF(
				CurM<[@InvoicedM]
				,[@InvoicedY]
				,IF(
					[@OrderY]<[@InvoicedY]
					,[@InvoicedY]-1
					,""
				)
			)
			,IF(
				[@OrderY]<[@InvoicedY]-1
				,IF(
					CurM<[@InvoicedM]
					,[@InvoicedY]
					,[@InvoicedY]-1
				)
				,IF(
					[@OrderY]=[@InvoicedY]-1
					,IF(
						CurM<[@InvoicedM]
						,[@InvoicedY]
						,""
					)
					,""
				)
			)
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- YBL1
----------------------------------------------------------------------------------------------------
IF(
	OR(
		[@IsScPlusIsHW]+[@IsCProUPG]+SUM([@[IsSuiteSpot]:[IsBESXDualModeUPG]])=0
		,[@YBL]=""
	)
	,""
	,IF(
		OR(
			AND(
				[@OrderY]=[@YBL]-1
				,[@OrderM]<=CurM
			)
			,[@OrderY]<[@YBL]-1
		)
		,[@YBL]-1
		,""
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- YBL2
----------------------------------------------------------------------------------------------------
IF(
	OR(
		[@IsScPlusIsHW]+[@IsCProUPG]+SUM([@[IsSuiteSpot]:[IsBESXDualModeUPG]])=0
		,[@YBL]=""
	)
	,""
	,IF(
		OR(
			AND(
				[@OrderY]=[@YBL]-2
				,[@OrderM]<=CurM
			)
			,[@OrderY]<[@YBL]-2
		)
		,[@YBL]-2
		,""
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- ORDER
----------------------------------------------------------------------------------------------------
IF(
	[@IsScPlusIsHW]=0
	,""
	,[@QtyOrderTransact]*[@IsScPlusIsHW]
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- SH
----------------------------------------------------------------------------------------------------
IF(
	[@YSH]=""
	,""
	,[@QtyOrderTransact]*[@IsScPlusIsHW]
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- BL
----------------------------------------------------------------------------------------------------
IF(
	[@YBL]=""
	,""
	,[@QtyOrderTransact]*[@IsScPlusIsHW]
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- BL1
----------------------------------------------------------------------------------------------------
IF(
	[@YBL1]=""
	,""
	,[@QtyOrderTransact]*[@IsScPlusIsHW]
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- BL2
----------------------------------------------------------------------------------------------------
IF(
	[@YBL2]=""
	,""
	,[@QtyOrderTransact]*[@IsScPlusIsHW]
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- TotBL
----------------------------------------------------------------------------------------------------
IF(
	[@BL]=""
	,""
	,SUM([@[BL]:[BL2]])/COUNT([@[BL]:[BL2]])
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- OrderDateCheck
----------------------------------------------------------------------------------------------------
IF(
	[@OrderY]<$CR$1
	,"Y"
	,IF(
		[@OrderM]<=$CQ$1
		,"Y"
		,"N"
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- ShippedDateCheck
----------------------------------------------------------------------------------------------------
IF(
	[@InvoicedY]<$CR$1
	,"Y"
	,IF(
		[@InvoicedM]<=$CQ$1
		,"Y"
		,"N"
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- QtyIncl
----------------------------------------------------------------------------------------------------
IF(
	COUNT([@[SH]:[BL2]])=0
	,""
	,SUM([@[SH]:[BL2]])/COUNT([@[SH]:[BL2]])
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- IsHWY66 Theme
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,0
	,IF(
		IFERROR(
			VLOOKUP([@ItemNumber],'part_filters'!Thm[#Data],2,FALSE)
			,"N"
		)="N"
		,"N"
		,"Y"
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- OrderNum-HWY66Theme
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,""
	,IF(
		[@[IsHWY66 Theme]]="N"
		,""
		,IFERROR(
			[@OrderNumber]&"-"&VLOOKUP([@ItemNumber],'part_filters'!Thm[#Data],3,FALSE)
			,"No Theme"
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- OrderHWY66 Theme
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,""
	,IF(
		[@ProductFamily]="Highway 66"
		,IFERROR(
			VLOOKUP([@OrderNumber]&"-*",[[OrderNum-HWY66Theme]:[OrderNum-HWY66Theme]],1,FALSE)
			,""
		)
		,""
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- HWY66Theme
----------------------------------------------------------------------------------------------------
IF(
	[@MainOrder]="Exclude"
	,""
	,IF(
		[@ProductFamily]="Highway 66"
		,IF(
			[@[OrderHWY66 Theme]]=""
			,"No theme"
			,IF(
				MID([@[OrderHWY66 Theme]],LEN([@[OrderHWY66 Theme]])-1,1)="-"
				,VLOOKUP(MID([@[OrderHWY66 Theme]],LEN([@[OrderHWY66 Theme]]),1),'part_filters'!Thm[[ID]:[ID2]],2,FALSE)
				,VLOOKUP(MID([@[OrderHWY66 Theme]],LEN([@[OrderHWY66 Theme]])-1,2),'part_filters'!Thm[[ID]:[ID2]],2,FALSE)
			)
		)
		,""
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- AMERSubReg
----------------------------------------------------------------------------------------------------
IF(
	[@MacroReg]="EMEA"
	,"Exclude"
	,IF(
		[@MacroReg]="INT"
		,IF(
			[@DistrPartner]="QAMF AU"
			,[@DistrPartner]
			,"Exclude"
		)
		,IF(
			OR(
				[@USSubRegNoMIL]="BAMF"
				,[@DistrPartner]="Direct"
			)
			,"Other"
			,IF(
				[@USSubRegNoMIL]="ME"
				,"ME"
				,IF(
					[@USSubRegNoMIL]="BNE"
					,VLOOKUP(LEFT([@State],2),'geo_filters'!USRegionsTb[[ST1]:[DSM 3]],2,FALSE)
					,IF(
						LEFT([@USSubRegNoMIL],4)="MIL-"
						,"INT MIL"
						,IF(
							[@USSubRegNoMIL]=""
							,[@SubReg]
							,[@USSubRegNoMIL]
						)
					)
				)
			)
		)
	)
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- CY-BL
----------------------------------------------------------------------------------------------------
IF(
	OR(
		NOT(
			[@YBL]=CurY
		)
		,[@AMERSubReg]="Exclude"
	)
	,""
	,[@BL]
)
----------------------------------------------------------------------------------------------------

----------------------------------------------------------------------------------------------------
----- AdjSalesRepRegion
----------------------------------------------------------------------------------------------------
IFERROR(
	IF(
		[@AMERSubReg]="Exclude"
		,"Exclude"
		,VLOOKUP(MID([@SalesRep],SEARCH(" - ",[@SalesRep])+3,LEN([@SalesRep])-SEARCH(" - ",[@SalesRep])-2),'geo_filters'!Salesmanagers[[DSM]:[RSM]],2,FALSE)
	)
	,[@AMERSubReg]
)
----------------------------------------------------------------------------------------------------

